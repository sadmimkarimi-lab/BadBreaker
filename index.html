<!DOCTYPE html>
<html lang="fa">

<head>
  <meta charset="UTF-8" />
  <title>Ø´Ú©Ø³ØªÙ† Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ - Tavita</title>
  <!-- ÙÙˆÙ†Øª Ø²ÛŒØ¨Ø§ Ùˆ Ø®ÙˆØ§Ù†Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Vazirmatn', sans-serif;
    }

    body {
      background: #111533;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    #top-bar {
      width: 100%;
      padding: 8px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      direction: ltr;
      font-size: 14px;
      gap: 8px;
    }

    #top-left {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    #top-right {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .iconBtn {
      border: none;
      padding: 4px 10px;
      border-radius: 999px;
      background: #2c2e7a;
      color: #fff;
      font-size: 14px;
      box-shadow: 0 0 6px rgba(0, 0, 0, .4);
      cursor: pointer;
      white-space: nowrap;
    }

    .iconBtn:active {
      transform: scale(.97)
    }

    #game-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px 10px 10px;
    }

    canvas {
      background: #141947;
      border-radius: 14px;
      box-shadow: 0 0 18px rgba(0, 0, 0, .7);
      touch-action: none;
    }

    #bottom-bar {
      width: 100%;
      padding: 4px 14px 10px;
      font-size: 12px;
      direction: rtl;
      opacity: .9;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    #hint {
      flex: 1;
      min-width: 150px;
    }

    #bottom-buttons {
      display: flex;
      gap: 6px;
    }

    .btn {
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      background: #1abc9c;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0, 0, 0, .5);
      white-space: nowrap;
    }

    .btn-shop {
      background: #ff8c00;
    }

    .btn:active {
      transform: scale(.97)
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .box {
      background: #1b144f;
      padding: 16px;
      border-radius: 16px;
      width: 90%;
      max-width: 380px;
      box-shadow: 0 0 18px rgba(0, 0, 0, .8);
      direction: rtl;
      text-align: right;
      font-size: 13px;
      line-height: 1.7;
      position: relative;
    }

    .box h3 {
      margin-bottom: 8px;
      font-size: 16px;
    }

    .closeBtn {
      margin-top: 10px;
      width: 100%;
      border: none;
      padding: 7px 14px;
      border-radius: 999px;
      background: #4444aa;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0, 0, 0, .5);
    }

    .closeBtn:active {
      transform: scale(.97)
    }

    .shopItem {
      background: #24145f;
      padding: 8px;
      border-radius: 10px;
      margin: 6px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      transition: transform .15s ease, box-shadow .15s ease;
    }

    .shopItem span {
      display: block
    }

    .shopItem button {
      padding: 4px 10px;
      font-size: 11px;
      border: none;
      border-radius: 999px;
      background: #ff8c00;
      color: #fff;
      cursor: pointer;
    }

    .shopItem.bought {
      transform: scale(1.03);
      box-shadow: 0 0 14px rgba(46, 204, 113, .8);
    }

    #shopMessage {
      position: absolute;
      top: 4px;
      left: 12px;
      font-size: 11px;
      color: #2ecc71;
      opacity: 0;
      pointer-events: none;
    }

    .shopMessageVisible {
      animation: shopFlash 1s ease-out forwards;
    }

    @keyframes shopFlash {
      0% {
        opacity: 0;
        transform: translateY(-4px);
      }

      20% {
        opacity: 1;
        transform: translateY(0);
      }

      80% {
        opacity: 1;
      }

      100% {
        opacity: 0;
        transform: translateY(-6px);
      }
    }

    #gameOverBox p {
      margin: 4px 0;
    }
  </style>
</head>

<body>
  <div id="top-bar">
    <div id="top-left">
      <div>Ø§Ù…ØªÛŒØ§Ø²: <span id="scoreEl">0</span></div>
      <div>Ù…Ø±Ø­Ù„Ù‡: <span id="levelEl">1</span></div>
      <div>â¤ï¸ <span id="livesEl">3</span></div>
    </div>
    <div id="top-right">
      <button id="soundBtn" class="iconBtn">ğŸ”Š</button>
      <button id="pauseBtn" class="iconBtn">â¸</button>
    </div>
  </div>

  <div id="game-container">
    <canvas id="game"></canvas>
  </div>

  <div id="bottom-bar">
    <div id="hint">Ø¨Ø§ Ø§Ù†Ú¯Ø´Øª Ù¾ÙØ¯ Ø±Ø§ Ø­Ø±Ú©Øª Ø¨Ø¯Ù‡ Ùˆ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ Ø±Ø§ Ø¨Ø´Ú©Ù† ğŸ’«</div>
    <div id="bottom-buttons">
      <button id="aboutBtn" class="btn">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</button>
      <button id="shopBtn" class="btn btn-shop">Ø´Ø§Ù¾</button>
    </div>
  </div>

  <!-- Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§ -->
  <div id="aboutOverlay" class="overlay">
    <div class="box">
      <h3>Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø·Ø§ÙˆÛŒØªØ§</h3>
      <p>
        Ø·Ø§ÙˆÛŒØªØ§ ÛŒÚ© Ú©Ø§Ù†Ø§Ù„ Ø¢Ù…ÙˆØ²Ø´ ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ Ùˆ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¨Ø§ Ø±ÙˆÛŒÚ©Ø±Ø¯ÛŒ
        Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø§Ù…Ø§ ØµÙ…ÛŒÙ…ÛŒØŒ Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ù…Ø­ØªÙˆØ§ÛŒ Ù…Ø¤Ø«Ø±ØŒ Ø®Ù„Ø§Ù‚ Ùˆ
        Ø¯Ø±Ø¢Ù…Ø¯Ø²Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯.
      </p>
      <p>
        Ø¯Ø± Ú©Ù†Ø§Ø± Ø¢Ù…ÙˆØ²Ø´ØŒ ØªÛŒÙ… Ø·Ø§ÙˆÛŒØªØ§ Ø§Ù†Ø¬Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ®ØµØµÛŒ Ù…Ø«Ù„ Ø³Ø§Ø®Øª ÙˆÛŒØ¯Ø¦ÙˆØŒ
        Ø·Ø±Ø§Ø­ÛŒ Ø¨Ø§Ø²ÛŒØŒ ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ÛŒ Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ Ùˆ Ø§Ø¬Ø±Ø§ÛŒ Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ
        Ø®Ù„Ø§Ù‚Ø§Ù†Ù‡ Ø±Ø§ Ù†ÛŒØ² Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ø¯.
      </p>
      <p>
        Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø±Ø§Ù‡ÛŒ Ø¨Ø§ Ø·Ø§ÙˆÛŒØªØ§ Ùˆ Ø¯ÛŒØ¯Ù† Ø¢Ù…ÙˆØ²Ø´â€ŒÙ‡Ø§ Ùˆ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø²
        Ø·Ø±ÛŒÙ‚ Ù„ÛŒÙ†Ú© Ø²ÛŒØ± Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„ Ø´ÙˆÛŒØ¯:
      </p>
      <a class="btn" style="display:inline-block;text-decoration:none;text-align:center;margin-top:8px;" href="https://eitaa.com/tavita" target="_blank">
        ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ø·Ø§ÙˆÛŒØªØ§ Ø¯Ø± Ø§ÛŒØªØ§
      </a>
      <button class="closeBtn" id="closeAbout">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>

  <!-- Ø´Ø§Ù¾ -->
  <div id="shopOverlay" class="overlay">
    <div class="box" id="shopBox">
      <h3>ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø±ÙØªØ§Ø±Ù‡Ø§ÛŒ Ø®ÙˆØ¨ ğŸŒ±</h3>
      <div id="shopMessage"></div>
      <div class="shopItem" data-item-row="pad">
        <span>Ù¾ÙØ¯ Ø¢Ú¯Ø§Ù‡â€ŒØªØ± (Ù¾Ù‡Ù†â€ŒØªØ± Ø´Ø¯Ù† Ù¾ÙØ¯)</span>
        <span>Ù‡Ø²ÛŒÙ†Ù‡: 150 Ø§Ù…ØªÛŒØ§Ø²</span>
        <button data-item="pad">Ø®Ø±ÛŒØ¯</button>
      </div>
      <div class="shopItem" data-item-row="strength">
        <span>ØªÙ„Ø§Ø´ Ø¨ÛŒØ´ØªØ± (ØªÙˆÙ¾ Ù‚ÙˆÛŒâ€ŒØªØ±)</span>
        <span>Ù‡Ø²ÛŒÙ†Ù‡: 220 Ø§Ù…ØªÛŒØ§Ø²</span>
        <button data-item="strength">Ø®Ø±ÛŒØ¯</button>
      </div>
      <div class="shopItem" data-item-row="slow">
        <span>Ø¢Ø±Ø§Ù…Ø´ Ø¯Ø±ÙˆÙ† (Ú©Ù†Ø¯ Ø´Ø¯Ù† ØªÙˆÙ¾ Ø¨Ø±Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Ø¨Ù‡ØªØ±)</span>
        <span>Ù‡Ø²ÛŒÙ†Ù‡: 180 Ø§Ù…ØªÛŒØ§Ø²</span>
        <button data-item="slow">Ø®Ø±ÛŒØ¯</button>
      </div>
      <button class="closeBtn" id="closeShop">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>

  <!-- Ú¯ÛŒÙ… Ø§ÙˆØ± -->
  <div id="gameOverOverlay" class="overlay">
    <div class="box" id="gameOverBox">
      <h3>Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ ğŸ®</h3>
      <p id="goScore">Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§: 0</p>
      <p id="goLevel" style="font-size:12px;opacity:.85;"></p>
      <p style="font-size:12px;opacity:.9;">
        Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒ Ùˆ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ Ø¨ÛŒØ´ØªØ±ÛŒ Ø±Ùˆ Ø¨Ø´Ú©Ù†ÛŒ ğŸ˜
      </p>
      <button id="retryBtn" class="closeBtn">Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("scoreEl");
    const levelEl = document.getElementById("levelEl");
    const livesEl = document.getElementById("livesEl");
    const soundBtn = document.getElementById("soundBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const hintEl = document.getElementById("hint");
    const aboutOverlay = document.getElementById("aboutOverlay");
    const aboutBtn = document.getElementById("aboutBtn");
    const closeAboutBtn = document.getElementById("closeAbout");
    const shopOverlay = document.getElementById("shopOverlay");
    const shopBtn = document.getElementById("shopBtn");
    const closeShopBtn = document.getElementById("closeShop");
    const shopMessage = document.getElementById("shopMessage");
    const gameOverOverlay = document.getElementById("gameOverOverlay");
    const goScore = document.getElementById("goScore");
    const goLevel = document.getElementById("goLevel");
    const retryBtn = document.getElementById("retryBtn");
    let w, h;

    function resizeCanvas() {
      w = Math.min(window.innerWidth * 0.95, 420);
      h = Math.min(window.innerHeight * 0.8, 720);
      canvas.width = w;
      canvas.height = h;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);
    // ØµØ¯Ø§
    let audioCtx;
    let isMuted = false;

    function beep(freq = 600, dur = 0.06) {
      if (isMuted) return;
      try {
        if (!audioCtx) audioCtx = new(window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.value = freq;
        osc.type = "square";
        gain.gain.value = 0.08;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + dur);
      } catch (e) {}
    }
    soundBtn.onclick = () => {
      isMuted = !isMuted;
      soundBtn.textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";
    };
    // Ù…ØªÙ†â€ŒÙ‡Ø§
    const badWords = [
      "ØªÙ†Ø¨Ù„ÛŒ", "Ø¯Ø±ÙˆØº", "Ø­Ø³Ø§Ø¯Øª", "ØºÛŒØ¨Øª", "Ù†Ø§Ø§Ù…ÛŒØ¯ÛŒ",
      "ØªØ±Ø³", "Ø®Ø´Ù…", "Ø¨Ø¯Ù‚ÙˆÙ„ÛŒ", "Ø®ÙˆØ¯Ú©Ù…\u200cØ¨ÛŒÙ†ÛŒ", "Ø¨ÛŒ\u200cØ§Ø­ØªØ±Ø§Ù…ÛŒ"
    ];
    const goodMessages = [
      "ØªÙˆ Ù…Ù‡Ø±Ø¨ÙˆÙ†ÛŒ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯ÛŒ â¤ï¸",
      "ØªÙˆ Ø¯Ø± Ø­Ø§Ù„ Ø±Ø´Ø¯ Ùˆ Ù¾ÛŒØ´Ø±ÙØªÛŒ ğŸ’ª",
      "ØªÙˆ ØµØ¨ÙˆØ± Ùˆ Ù‚ÙˆÛŒ Ù‡Ø³ØªÛŒ ğŸ’™",
      "ØªÙˆ Ø±Ø§Ø³ØªÚ¯Ùˆ Ùˆ Ø´Ø¬Ø§Ø¹ÛŒ ğŸ’›",
      "ØªÙˆ Ø§Ù†Ø³Ø§Ù† Ù…Ø«Ø¨ØªÛŒ Ù‡Ø³ØªÛŒ âœ¨",
      "ØªÙˆ Ø§Ø² Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯Øª Ù‚ÙˆÛŒâ€ŒØªØ±ÛŒ ğŸ˜",
      "ØªÙˆ Ø§Ù„Ù‡Ø§Ù…â€ŒØ¨Ø®Ø´ Ø§Ø·Ø±Ø§ÙÛŒØ§Ù†ÛŒ ğŸ’œ"
    ];

    function randomItem(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }
    // ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²ÛŒ
    let paddle, ball, bricks, powerUps, score, level, lives,
      running, paused, strongBallTicks = 0,
      slowBallTicks = 0,
      burstTicks = 0;

    function updateHUD() {
      scoreEl.textContent = score;
      levelEl.textContent = level;
      livesEl.textContent = lives;
    }

    function flashHint(text, ms = 2600) {
      hintEl.textContent = text;
      if (flashHint._t) clearTimeout(flashHint._t);
      flashHint._t = setTimeout(() => {
        hintEl.textContent = "Ø¨Ø§ Ø§Ù†Ú¯Ø´Øª Ù¾ÙØ¯ Ø±Ø§ Ø­Ø±Ú©Øª Ø¨Ø¯Ù‡ Ùˆ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ Ø±Ø§ Ø¨Ø´Ú©Ù† ğŸ’«";
      }, ms);
    }
    // Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ú©Ù„â€ŒÙ‡Ø§:
    // Ù…Ø±Ø§Ø­Ù„ Û±â€“Û±Û°: Ù…Ø±Ø¨Ø¹ØŒ Û±Û±â€“Û²Û°: Ø¯Ø§ÛŒØ±Ù‡ØŒ Û²Û±â€“Û³Û°: Ù‚Ù„Ø¨
    function patternForLevel(lvl) {
  if (lvl <= 10) return "SQUARE";   // Ù…Ø±Ø§Ø­Ù„ Û± ØªØ§ Û±Û°: Ù…Ø±Ø¨Ø¹
  if (lvl <= 20) return "CIRCLE";   // Ù…Ø±Ø§Ø­Ù„ Û±Û± ØªØ§ Û²Û°: Ø¯Ø§ÛŒØ±Ù‡
  if (lvl <= 30) return "HEART";    // Ù…Ø±Ø§Ø­Ù„ Û²Û± ØªØ§ Û³Û°: Ù‚Ù„Ø¨
  return "SQUARE";  // Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ø§ÛŒ Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ
}

function brickSizeByLevel(lvl) {
  let scale = 1; // Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù¾Ø§ÛŒÙ‡ Ø¢Ø¬Ø±Ù‡Ø§

  // Ù…Ø±Ø§Ø­Ù„ 1 ØªØ§ 10: Ø¢Ø¬Ø±Ù‡Ø§ Ø§Ø² 3 Ø¨Ù‡ 1 Ú©ÙˆÚ†Ú© Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
  if (lvl <= 10) {
    scale = 3 - (0.2 * (lvl - 1)); // Ø§Ø² 3 Ø¨Ù‡ 1 Ú©Ø§Ù‡Ø´ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯
  } 
  // Ù…Ø±Ø§Ø­Ù„ 11 ØªØ§ 20: Ø¢Ø¬Ø±Ù‡Ø§ Ø§Ø² 2 Ø¨Ù‡ 1 Ú©ÙˆÚ†Ú© Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
  else if (lvl <= 20) {
    scale = 2 - (0.1 * (lvl - 11)); // Ø§Ø² 2 Ø¨Ù‡ 1 Ú©Ø§Ù‡Ø´ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯
  } 
  // Ù…Ø±Ø§Ø­Ù„ 21 ØªØ§ 30: Ø¢Ø¬Ø±Ù‡Ø§ Ø§Ø² 1.5 Ø¨Ù‡ 1 Ú©ÙˆÚ†Ú© Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
  else if (lvl <= 30) {
    scale = 1.5 - (0.05 * (lvl - 21)); // Ø§Ø² 1.5 Ø¨Ù‡ 1 Ú©Ø§Ù‡Ø´ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯
  }

  return scale;
}

function buildPatternBricks(name, lvl) {
  let grid = [];
  const scale = brickSizeByLevel(lvl); // Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¢Ø¬Ø±Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø·Ø­

  if (name === "SQUARE") {
    grid = [
      "11111111",
      "11111111",
      "11111111",
      "11111111"
    ];
  } else if (name === "CIRCLE") {
    grid = [
      "000111000",
      "001111100",
      "011111110",
      "011111110",
      "001111100",
      "000111000"
    ];
  } else if (name === "HEART") {
    grid = [
      "00111100111100",
      "01111111111110",
      "11111111111111",
      "11111111111111",
      "01111111111110",
      "00111111111100",
      "00011111111000",
      "00001111110000",
      "00000111100000",
      "00000011000000"
    ];
  }

  const rows = grid.length;
  const cols = grid[0].length;
  const padding = 4;
  const brickW = (w - (cols + 1) * padding) / cols;
  const brickH = 14;
  const marginTop = 40;
  const out = [];

  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      if (grid[r][c] === "1") {
        const x = padding + c * (brickW + padding);
        const y = marginTop + r * (brickH + padding);
        const hits = 1 + Math.floor(level / 2);
        const label = randomItem(badWords);
        const typeRand = Math.random();
        let type = "normal";
        if (typeRand < 0.1) type = "ice";
        else if (typeRand < 0.18) type = "strong";
        else if (typeRand < 0.24) type = "bomb";
        else if (typeRand < 0.28) type = "golden";

        out.push({
          x,
          y,
          w: brickW * scale,  // Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¢Ø¬Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø·Ø­
          h: brickH * scale,  // Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¢Ø¬Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø·Ø­
          hits,
          label,
          type
        });
      }
    }
  }

  return out;
}
    function makeRandomLevel() {
      const rows = 4 + level;
      const cols = 8;
      const marginTop = 40;
      const padding = 4;
      const brickW = (w - (cols + 1) * padding) / cols;
      const brickH = 14;
      const arr = [];
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          if (Math.random() < 0.85) {
            const x = padding + c * (brickW + padding);
            const y = marginTop + r * (brickH + padding);
            const hits = 1 + Math.floor(level / 2);
            const label = randomItem(badWords);
            const typeRand = Math.random();
            let type = "normal";
            if (typeRand < 0.1) type = "ice";
            else if (typeRand < 0.18) type = "strong";
            else if (typeRand < 0.24) type = "bomb";
            else if (typeRand < 0.28) type = "golden";
            arr.push({
              x,
              y,
              w: brickW,
              h: brickH,
              hits,
              label,
              type
            });
          }
        }
      }
      return arr;
    }

    function buildLevel() {
      const name = patternForLevel(level);
      if (name) {
        bricks = buildPatternBricks(name);
        flashHint("Ù…Ø±Ø­Ù„Ù‡ ÙˆÛŒÚ˜Ù‡: " + name + " âœ¨");
      } else {
        bricks = makeRandomLevel();
      }
    }

    function resetGame() {
      const minPadW = 40;
      const maxPadW = 100;
      const padW = minPadW;
      const padH = 12;
      paddle = {
        x: (w - padW) / 2,
        y: h - 40,
        w: padW,
        h: padH,
        minW: minPadW,
        maxW: maxPadW,
        speed: 9
      };
      ball = {
        x: w / 2,
        y: h - 60,
        r: 6,
        vx: 3.5,
        vy: -4.5,
        stuckToPaddle: true
      };
      powerUps = [];
      score = 0;
      level = 1;
      lives = 3;
      running = true;
      paused = false;
      strongBallTicks = 0;
      slowBallTicks = 0;
      burstTicks = 0;
      buildLevel();
      updateHUD();
    }
    resetGame();
    // Ú©Ù†ØªØ±Ù„ Ù¾Ø¯
    function movePaddleTo(clientX) {
      const rect = canvas.getBoundingClientRect();
      const x = (clientX - rect.left) * (w / rect.width);
      paddle.x = x - paddle.w / 2;
      if (paddle.x < 0) paddle.x = 0;
      if (paddle.x + paddle.w > w) paddle.x = w - paddle.w;
      if (ball.stuckToPaddle) {
        ball.x = paddle.x + paddle.w / 2;
        ball.y = paddle.y - ball.r - 1;
      }
    }
    canvas.addEventListener("mousemove", e => {
      if (!running || paused) return;
      movePaddleTo(e.clientX);
    });
    canvas.addEventListener("mousedown", e => {
      if (!running || paused) return;
      if (ball.stuckToPaddle) {
        ball.stuckToPaddle = false;
        beep(700);
      }
    });
    canvas.addEventListener("touchstart", e => {
      if (!running || paused) return;
      const touch = e.touches[0];
      movePaddleTo(touch.clientX);
      if (ball.stuckToPaddle) {
        ball.stuckToPaddle = false;
        beep(700);
      }
      e.preventDefault();
    }, {
      passive: false
    });
    canvas.addEventListener("touchmove", e => {
      if (!running || paused) return;
      const touch = e.touches[0];
      movePaddleTo(touch.clientX);
      e.preventDefault();
    }, {
      passive: false
    });
    pauseBtn.onclick = () => {
      if (!running) return;
      paused = !paused;
      pauseBtn.textContent = paused ? "â–¶ï¸" : "â¸";
      flashHint(paused ? "Ø¨Ø§Ø²ÛŒ Ù…ØªÙˆÙ‚Ù Ø´Ø¯ â¸" : "Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§Ø²ÛŒ â–¶ï¸", 1500);
    };
    // Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§
    aboutBtn.onclick = () => {
      aboutOverlay.style.display = "flex";
    };
    closeAboutBtn.onclick = () => {
      aboutOverlay.style.display = "none";
    };
    aboutOverlay.addEventListener("click", e => {
      if (e.target === aboutOverlay) aboutOverlay.style.display = "none";
    });
    // Ø´Ø§Ù¾
    function showShopMsg(text) {
      shopMessage.textContent = text;
      shopMessage.classList.remove("shopMessageVisible");
      void shopMessage.offsetWidth;
      shopMessage.classList.add("shopMessageVisible");
    }
    shopBtn.onclick = () => {
      if (!running) return;
      shopOverlay.style.display = "flex";
    };
    closeShopBtn.onclick = () => {
      shopOverlay.style.display = "none";
    };
    shopOverlay.addEventListener("click", e => {
      if (e.target === shopOverlay) shopOverlay.style.display = "none";
    });
    document.querySelectorAll(".shopItem button").forEach(btn => {
      btn.addEventListener("click", () => {
        const item = btn.getAttribute("data-item");
        let cost = 0;
        if (item === "pad") cost = 150;
        else if (item === "strength") cost = 220;
        else if (item === "slow") cost = 180;
        if (score < cost) {
          showShopMsg("Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒ ğŸ˜…");
          beep(200, 0.1);
          return;
        }
        score -= cost;
        if (item === "pad") {
          paddle.w = Math.min(paddle.w + 12, paddle.maxW);
          flashHint("Ù¾Ø¯Øª Ø¢Ú¯Ø§Ù‡â€ŒØªØ± Ùˆ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø´Ø¯ ğŸŒ±");
        } else if (item === "strength") {
          strongBallTicks += 1000;
          flashHint("ØªÙˆÙ¾ Ù‚ÙˆÛŒâ€ŒØªØ± Ø´Ø¯Ø› Ø±Ø§Ø­Øªâ€ŒØªØ± Ù…ÛŒâ€ŒØ´Ú©Ù†ÛŒ ğŸ’ª");
        } else if (item === "slow") {
          slowBallTicks += 900;
          flashHint("Ø¢Ø±Ø§Ù…Ø´Ø› ØªÙˆÙ¾ Ú©Ù…ÛŒ Ú©Ù†Ø¯ØªØ± Ø´Ø¯ ğŸ’™");
        }
        const row = document.querySelector(`.shopItem[data-item-row="${item}"]`);
        if (row) {
          row.classList.add("bought");
          setTimeout(() => row.classList.remove("bought"), 260);
        }
        showShopMsg("Ø±ÙØªØ§Ø± Ø®ÙˆØ¨ Ø®Ø±ÛŒØ¯ÛŒØ› Ø¢ÙØ±ÛŒÙ† Ø¨Ù‡ ØªÙˆ â¤ï¸");
        updateHUD();
      });
    });
    // Ù¾Ø§ÙˆØ±Ø¢Ù¾â€ŒÙ‡Ø§ Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²ÛŒ (Ø´Ø§Ù…Ù„ Burst)
    function spawnPowerUp(x, y) {
      const types = ["pad", "strength", "slow", "burst"];
      const type = types[Math.floor(Math.random() * types.length)];
      const labelGood = randomItem(goodMessages);
      powerUps.push({
        x,
        y,
        r: 9,
        vy: 1.3,
        type,
        labelGood
      });
    }

    function applyPowerUp(pu) {
      if (pu.type === "pad") {
        paddle.w = Math.min(paddle.w + 10, paddle.maxW);
        flashHint("Ù…Ù‡Ø±Ø¨Ø§Ù†ÛŒ Ù¾Ø¯Øª Ø±Ùˆ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ú©Ø±Ø¯ â¤ï¸");
      } else if (pu.type === "strength") {
        strongBallTicks += 900;
        flashHint("ØªÙ„Ø§Ø´ Ø¨ÛŒØ´ØªØ±Ø› ØªÙˆÙ¾ Ù‚ÙˆÛŒâ€ŒØªØ± Ø´Ø¯ ğŸ’ª");
      } else if (pu.type === "slow") {
        slowBallTicks += 800;
        flashHint("Ø¢Ø±Ø§Ù…Ø´Ø› ØªÙˆÙ¾ Ú©Ù…ÛŒ Ú©Ù†Ø¯ØªØ± Ø´Ø¯ ğŸ’™");
      } else if (pu.type === "burst") {
        // Ø­Ø§Ù„Øª Ú†Ù†Ø¯ØªÙˆÙ¾ÛŒ (Ø§ÙÚ©Øª Ø¨ØµØ±ÛŒ)
        burstTicks += 260; // Ø­Ø¯ÙˆØ¯ Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡
        flashHint("Ø­Ø§Ù„Øª Ú†Ù†Ø¯ØªÙˆÙ¾ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯! ğŸ˜ğŸ”¥", 3000);
      }
      flashHint(pu.labelGood, 2800);
      beep(900, 0.1);
    }
    // Ú¯ÛŒÙ…â€ŒØ§ÙˆØ±
    function showGameOver() {
      running = false;
      gameOverOverlay.style.display = "flex";
      goScore.textContent = "Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§: " + score;
      goLevel.textContent = "Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ø±Ø³ÛŒØ¯ÛŒ: " + level;
    }
    retryBtn.onclick = () => {
      gameOverOverlay.style.display = "none";
      resetGame();
      running = true;
    };
    gameOverOverlay.addEventListener("click", e => {
      if (e.target === gameOverOverlay) {
        gameOverOverlay.style.display = "none";
        resetGame();
        running = true;
      }
    });

    function update() {
      if (!running || paused) return;
      if (strongBallTicks > 0) strongBallTicks--;
      if (slowBallTicks > 0) slowBallTicks--;
      if (burstTicks > 0) burstTicks--;
      if (ball.stuckToPaddle) {
        ball.x = paddle.x + paddle.w / 2;
        ball.y = paddle.y - ball.r - 1;
        return;
      }
      let speedFactor = 1;
      if (slowBallTicks > 0) speedFactor *= 0.7;
      ball.x += ball.vx * speedFactor;
      ball.y += ball.vy * speedFactor;
      // Ø¯ÛŒÙˆØ§Ø±Ù‡Ø§
      if (ball.x - ball.r < 0) {
        ball.x = ball.r;
        ball.vx *= -1;
      }
      if (ball.x + ball.r > w) {
        ball.x = w - ball.r;
        ball.vx *= -1;
      }
      if (ball.y - ball.r < 0) {
        ball.y = ball.r;
        ball.vy *= -1;
      }
      // Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ Ù¾Ø¯
      if (
        ball.y + ball.r >= paddle.y &&
        ball.y + ball.r <= paddle.y + paddle.h &&
        ball.x >= paddle.x && ball.x <= paddle.x + paddle.w &&
        ball.vy > 0
      ) {
        const hitPos = (ball.x - (paddle.x + paddle.w / 2)) / (paddle.w / 2);
        ball.vx = hitPos * 5;
        ball.vy = -Math.abs(ball.vy);
        beep(600);
      }
      // Ø§ÙØªØ§Ø¯Ù† Ù¾Ø§ÛŒÛŒÙ†
      if (ball.y - ball.r > h) {
        lives--;
        updateHUD();
        if (lives <= 0) {
          beep(200, 0.2);
          showGameOver();
          return;
        } else {
          beep(250, 0.16);
          ball.x = paddle.x + paddle.w / 2;
          ball.y = paddle.y - ball.r - 1;
          ball.vx = 3.5 * (Math.random() < 0.5 ? -1 : 1);
          ball.vy = -4.5;
          ball.stuckToPaddle = true;
          burstTicks = 0; // Ø±ÛŒØ³Øª Ø­Ø§Ù„Øª Ú†Ù†Ø¯ØªÙˆÙ¾ÛŒ
        }
      }
      // Ù¾Ø§ÙˆØ±Ø¢Ù¾â€ŒÙ‡Ø§
      for (const pu of powerUps) {
        pu.y += pu.vy;
      }
      for (let i = powerUps.length - 1; i >= 0; i--) {
        const pu = powerUps[i];
        if (
          pu.y + pu.r >= paddle.y &&
          pu.y - pu.r <= paddle.y + paddle.h &&
          pu.x >= paddle.x && pu.x <= paddle.x + paddle.w
        ) {
          applyPowerUp(pu);
          powerUps.splice(i, 1);
        } else if (pu.y - pu.r > h) {
          powerUps.splice(i, 1);
        }
      }
      // Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ Ø¢Ø¬Ø±Ù‡Ø§
      for (let i = bricks.length - 1; i >= 0; i--) {
        const b = bricks[i];
        if (
          ball.x + ball.r > b.x &&
          ball.x - ball.r < b.x + b.w &&
          ball.y + ball.r > b.y &&
          ball.y - ball.r < b.y + b.h
        ) {
          const overlapL = ball.x + ball.r - b.x;
          const overlapR = b.x + b.w - (ball.x - ball.r);
          const overlapT = ball.y + ball.r - b.y;
          const overlapB = b.y + b.h - (ball.y - ball.r);
          const minO = Math.min(overlapL, overlapR, overlapT, overlapB);
          if (minO === overlapL || minO === overlapR) ball.vx *= -1;
          else ball.vy *= -1;
          let damage = 1;
          if (strongBallTicks > 0) damage = 2;
          if (b.type === "ice") {
            if (!b._iceHit) {
              b._iceHit = true;
            } else {
              b.hits -= damage;
            }
          } else if (b.type === "strong") {
            b.hits -= damage * 0.8;
          } else if (b.type === "golden") {
            b.hits -= damage;
          } else {
            b.hits -= damage;
          }
          if (b.hits <= 0) {
            let baseScore = 10;
            if (b.type === "strong") baseScore = 14;
            if (b.type === "golden") baseScore = 20;
            score += baseScore;
            if (Math.random() < 0.25) spawnPowerUp(b.x + b.w / 2, b.y + b.h / 2);
            if (b.type === "bomb") {
              for (const nb of bricks) {
                if (nb === b) continue;
                const dx = (nb.x + nb.w / 2) - (b.x + b.w / 2);
                const dy = (nb.y + nb.h / 2) - (b.y + b.h / 2);
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 60) {
                  nb.hits -= damage;
                }
              }
            }
            flashHint("ÛŒÚ©ÛŒ Ø§Ø² \"" + b.label + "\" Ù‡Ø§ Ø±Ùˆ Ø´Ú©Ø³ØªÛŒ ğŸ‘", 2600);
            bricks.splice(i, 1);
          } else {
            score += 3;
          }
          beep(800, 0.05);
          updateHUD();
          break;
        }
      }
      // Ø§Ú¯Ù‡ Ù‡Ù…Ù‡ Ø¢Ø¬Ø±Ù‡Ø§ Ø±ÙØªÙ† â†’ Ù„ÙˆÙ„ Ø¨Ø¹Ø¯
      if (bricks.length === 0) {
        level++;
        ball.stuckToPaddle = true;
        ball.x = paddle.x + paddle.w / 2;
        ball.y = paddle.y - ball.r - 1;
        ball.vx *= 1.08;
        ball.vy *= 1.08;
        buildLevel();
        updateHUD();
        flashHint("Ù…Ø±Ø­Ù„Ù‡ " + level + " Ø´Ø±ÙˆØ¹ Ø´Ø¯ âœ¨", 2000);
        beep(1000, 0.15);
      }
    }

    function draw() {
      ctx.clearRect(0, 0, w, h);
      const g = ctx.createLinearGradient(0, 0, 0, h);
      g.addColorStop(0, "#151b5c");
      g.addColorStop(1, "#09071e");
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, w, h);
      // Ø¢Ø¬Ø±Ù‡Ø§
      for (const b of bricks) {
        let color = "#ffb347";
        if (b.type === "ice") color = "#66d9ff";
        else if (b.type === "strong") color = "#ff6f91";
        else if (b.type === "bomb") color = "#c084ff";
        else if (b.type === "golden") color = "#ffd700";
        ctx.fillStyle = color;
        ctx.fillRect(b.x, b.y, b.w, b.h);
        ctx.fillStyle = "#00000040";
        ctx.fillRect(b.x, b.y + b.h - 3, b.w, 3);
        // Ù…ØªÙ† Ø¹Ø§Ø¯Øª Ø¨Ø¯
        ctx.save();
        ctx.fillStyle = "#111";
        ctx.font = "9px Vazirmatn";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.direction = "rtl";
        ctx.fillText(b.label, b.x + b.w / 2, b.y + b.h / 2);
        ctx.restore();
      }
      // Ù¾Ø§ÙˆØ±Ø¢Ù¾â€ŒÙ‡Ø§
      for (const pu of powerUps) {
        let c = "#1abc9c";
        if (pu.type === "strength") c = "#ff9f43";
        else if (pu.type === "slow") c = "#9b59b6";
        else if (pu.type === "burst") c = "#e91e63";
        ctx.beginPath();
        ctx.arc(pu.x, pu.y, pu.r, 0, Math.PI * 2);
        const g2 = ctx.createRadialGradient(pu.x, pu.y, 2, pu.x, pu.y, pu.r + 3);
        g2.addColorStop(0, "#ffffff");
        g2.addColorStop(1, c);
        ctx.fillStyle = g2;
        ctx.fill();
        ctx.strokeStyle = "#ffffffaa";
        ctx.lineWidth = 1;
        ctx.stroke();
      }
      // Ù¾Ø¯
      ctx.fillStyle = "#3ac7ff";
      ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h);
      ctx.fillStyle = "#ffffff55";
      ctx.fillRect(paddle.x, paddle.y, paddle.w, 3);
      // ØªÙˆÙ¾ â€“ Ø­Ø§Ù„Øª Burst (ØªÙˆÙ¾â€ŒÙ‡Ø§ÛŒ Ø´Ø¨Ø­ÛŒ Ø§Ø·Ø±Ø§Ù)
      if (burstTicks > 0) {
        const t = Date.now() / 300;
        const count = 4;
        const offset = 8;
        for (let i = 0; i < count; i++) {
          const ang = (Math.PI * 2 / count) * i + t;
          const bx = ball.x + Math.cos(ang) * offset;
          const by = ball.y + Math.sin(ang) * offset;
          ctx.beginPath();
          ctx.arc(bx, by, ball.r - 2, 0, Math.PI * 2);
          ctx.fillStyle = "rgba(255,255,255,0.35)";
          ctx.fill();
        }
      }
      // ØªÙˆÙ¾ Ø§ØµÙ„ÛŒ
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
      ctx.fillStyle = strongBallTicks > 0 ? "#fffb8a" : "#ffffff";
      ctx.fill();
      ctx.strokeStyle = "#ffffff55";
      ctx.lineWidth = 1;
      ctx.stroke();
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>

</html>
